version: 2

# Tests for MasterData models
models:
  - name: DimClubs
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - ClubNumber
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - DimClubId

  - name: DimDates
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - Date
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - DimDateId

# Tests for Memberships models
  - name: DimMembershipAccounts
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - AccountNumberFull
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - DimMembershipAccountId
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - ClubNumber
            - AccountNumber

  - name: DimMembershipCards
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - MembershipNumber
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - DimMembershipCardId
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - ClubNumber
            - AccountNumber
            - CardNumber

  - name: FactMembershipTransactions
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - FactMembershipTransactionId
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - OrderNumber

# Relationship tests
tests:
  # Test foreign key relationships using Kimball surrogate keys
  - name: test_fact_transactions_club_fk
    description: "Test that all transactions have valid club references"
    model: FactMembershipTransactions
    test: relationships_where
    config:
      to: ref('DimClubs')
      from_field: DimClubNumberId
      to_field: DimClubId
      where: "DimClubNumberId is not null"

  - name: test_fact_transactions_account_fk
    description: "Test that all transactions have valid account references"
    model: FactMembershipTransactions
    test: relationships_where
    config:
      to: ref('DimMembershipAccounts')
      from_field: DimMembershipAccountId
      to_field: DimMembershipAccountId
      where: "DimMembershipAccountId is not null"

  - name: test_fact_transactions_transaction_date_fk
    description: "Test that all transactions have valid transaction date references"
    model: FactMembershipTransactions
    test: relationships_where
    config:
      to: ref('DimDates')
      from_field: DimDateTransactionDateId
      to_field: DimDateId
      where: "DimDateTransactionDateId is not null"

  - name: test_fact_transactions_effective_date_fk
    description: "Test that all transactions have valid effective date references"
    model: FactMembershipTransactions
    test: relationships_where
    config:
      to: ref('DimDates')
      from_field: DimDateEffectiveDateId
      to_field: DimDateId
      where: "DimDateEffectiveDateId is not null"

  - name: test_fact_transactions_expired_date_fk
    description: "Test that all transactions have valid expired date references"
    model: FactMembershipTransactions
    test: relationships_where
    config:
      to: ref('DimDates')
      from_field: DimDateExpiredDateId
      to_field: DimDateId
      where: "DimDateExpiredDateId is not null"

# Data quality tests
  - name: test_transaction_amounts_positive
    description: "Test that transaction amounts are positive"
    model: FactMembershipTransactions
    test: dbt_utils.expression_is_true
    config:
      expression: "TotalCost > 0 and TotalUsdCostNet > 0"

  - name: test_account_dates_logical
    description: "Test that account dates are logical (opened before expired)"
    model: DimMembershipAccounts
    test: dbt_utils.expression_is_true
    config:
      expression: "DateAccountOpened <= ExpirationDate or ExpirationDate is null"

  - name: test_card_dates_logical
    description: "Test that card dates are logical (issued before cancelled)"
    model: DimMembershipCards
    test: dbt_utils.expression_is_true
    config:
      expression: "IssuedDate <= CancelDate or CancelDate is null"

  - name: test_transaction_dates_logical
    description: "Test that transaction dates are logical (effective before expired)"
    model: FactMembershipTransactions
    test: dbt_utils.expression_is_true
    config:
      expression: "EffectiveDate <= ExpiredDate or ExpiredDate is null"
